<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
✅ namespace = ProductRepository 인터페이스와 매핑됨
- ProductRepository.java 메서드명 = 아래 id 값과 1:1로 연결됨
-->
<mapper namespace="com.magamsale.store.repository.ProductRepository">

    <!-- =========================================================
     ✅ 1) 상품 등록 (CREATE)
     - ProductCreateDTO 를 받아 product_tb에 INSERT
    ========================================================= -->
    <insert id="createProduct" parameterType="com.magamsale.store.dto.ProductCreateDTO">
        <![CDATA[
    INSERT INTO product_tb
    (
    seller_uid,
    name,
    original_price,
    sale_price,
    deadline_time,
    notice,
    sale_quantity,
    image_url,
    store_lat,
    store_lng,
    created_at
    )
    VALUES
    (
    #{sellerUid},
    #{name},
    #{originalPrice},
    #{salePrice},
    #{deadlineTime},
    #{notice},
    #{saleQuantity},
    #{imageUrl},
    #{storeLat},
    #{storeLng},
    DATE_ADD(NOW(), INTERVAL 9 HOUR)
    )
    ]]>
    </insert>

    <!-- =========================================================
     ✅ 2) 전체 상품 조회 (메인페이지 등에서 사용)
     - product_tb + seller_tb JOIN
     - 최신 등록순( created_at DESC )
    ========================================================= -->
    <select id="findAllProducts" resultType="com.magamsale.store.entity.Product">
        SELECT
        p.product_id     AS productId,
        p.seller_uid     AS sellerUid,
        p.name           AS productName,
        p.original_price AS originalPrice,
        p.sale_price     AS salePrice,
        p.deadline_time  AS deadlineTime,
        p.notice,
        p.image_url      AS imageUrl,
        p.store_lat      AS storeLat,
        p.store_lng      AS storeLng,
        p.sale_quantity  AS saleQuantity,
        p.status         AS status,
        s.store_name     AS storeName,
        s.address        AS address
        FROM product_tb p
        JOIN seller_tb s ON p.seller_uid = s.uid

        <!--   소프트삭제/숨김 제외     -->
        WHERE p.status = 'ACTIVE'
        AND (p.deadline_time IS NULL OR p.deadline_time > NOW())

        <!-- ✅ 핵심: 소프트삭제된 상품은 내려주지 않음 -->
<!--        WHERE COALESCE(p.status, 'ACTIVE') NOT IN ('DELETED', 'HIDDEN')-->
<!--        HIDDEN도 메인에서 보이면 안 되면 위처럼 유지-->
<!--        만약 "삭제만" 숨기고 HIDDEN은 메인에 보여야 하면 아래로 바꿔:-->
<!--        WHERE COALESCE(p.status, 'ACTIVE') != 'DELETED'-->

        ORDER BY p.created_at DESC
    </select>

    <!-- =========================================================
     ✅ 3) 사장님별 상품 조회 (기존 기능 유지)
     - sellerUid로 product_tb 조회
    ========================================================= -->
    <select id="findProductsBySeller"
            parameterType="int"
            resultType="com.magamsale.store.entity.Product">
        SELECT
        p.product_id      AS productId,
        p.seller_uid      AS sellerUid,
        p.name            AS productName,
        p.original_price  AS originalPrice,
        p.sale_price      AS salePrice,
        p.deadline_time   AS deadlineTime,
        p.image_url       AS imageUrl,
        p.notice,
        S.address         AS address,
        S.store_name      AS storeName,
        p.store_lat       AS storeLat,
        p.store_lng       AS storeLng,
        p.created_at      AS createdAt,
        p.status
        FROM product_tb p
        WHERE seller_uid = #{sellerUid}
        ORDER BY created_at DESC
    </select>

    <!-- =========================================================
     ✅ 4) 상품 상세 조회 (ProductDetailDTO 반환)
     - product_tb + seller_tb JOIN
     - productId 기준 1건
    ========================================================= -->
    <select id="findProductById"
            parameterType="int"
            resultType="com.magamsale.store.dto.ProductDetailDTO">
        SELECT
        p.product_id     AS productId,
        p.seller_uid     AS sellerUid,
        p.name           AS productName,
        p.original_price AS originalPrice,
        p.sale_price     AS salePrice,
        p.deadline_time  AS deadlineTime,
        p.notice,
        p.image_url      AS imageUrl,
        p.store_lat      AS storeLat,
        p.store_lng      AS storeLng,
        s.store_name     AS storeName,
        s.address        AS address,
        p.sale_quantity  AS saleQuantity,
        p.status,
        s.phone_number   AS phoneNumber,
        s.store_open     AS storeOpen,
        s.store_close    AS storeClose,
        s.bank_name      AS bankName,
        s.account_number AS accountNumber,
        s.account_holder AS accountHolder
        FROM product_tb p
        JOIN seller_tb s ON p.seller_uid = s.uid
        WHERE p.product_id = #{productId}
    </select>

    <!-- =========================================================
     ✅ 5) 상품 수정 (UPDATE)
     - null 값은 COALESCE로 기존값 유지
    ========================================================= -->
    <update id="updateProduct"
            parameterType="com.magamsale.store.entity.Product">
        UPDATE product_tb
        SET
        name           = COALESCE(#{name}, name),
        original_price = COALESCE(#{originalPrice}, original_price),
        sale_price     = COALESCE(#{salePrice}, sale_price),
        deadline_time  = COALESCE(#{deadlineTime}, deadline_time),
        status         = COALESCE(#{status}, status),
        notice         = COALESCE(#{notice}, notice),
        image_url      = COALESCE(#{imageUrl}, image_url),
        store_lat      = COALESCE(#{storeLat}, store_lat),
        store_lng      = COALESCE(#{storeLng}, store_lng)
        WHERE product_id = #{productId}
    </update>

    <!-- =========================================================
     ✅ 6) 상품 삭제(하드 삭제)
     - DB에서 row 자체 삭제
     ⚠️ 실서비스에서는 보통 소프트삭제(상태 DELETED) 사용 권장
    ========================================================= -->
    <delete id="deleteProduct" parameterType="int">
        DELETE FROM product_tb
        WHERE product_id = #{productId}
    </delete>

    <!-- =========================================================
     ✅ 7) 판매자 상품 통계 조회
     - total / sold / selling / closed 집계
    ========================================================= -->
    <select id="selectSellerProductStats" parameterType="int"
            resultType="com.magamsale.store.dto.ProductStatsResponse">
        SELECT
        COUNT(*) AS total,
        SUM(CASE WHEN status IN ('SOLD','SOLD_OUT','DONE') THEN 1 ELSE 0 END) AS sold,
        SUM(CASE WHEN status IN ('ON_SALE','SELLING','ACTIVE') THEN 1 ELSE 0 END) AS selling,
        SUM(CASE WHEN status IN ('CLOSED','EXPIRED','ENDED') THEN 1 ELSE 0 END) AS closed
        FROM product_tb
        WHERE seller_uid = #{sellerUid}
    </select>

    <!-- =========================================================
     ✅ 8) 상품관리(관리페이지) 전용 조회
     - seller_tb JOIN
     - DELETED 제외
     - sale_quantity / status 포함
    ========================================================= -->
    <select id="findProductsBySellerForManage"
            parameterType="int"
            resultType="com.magamsale.store.entity.Product">
        SELECT
        p.product_id      AS productId,
        p.seller_uid      AS sellerUid,
        p.name            AS productName,
        p.original_price  AS originalPrice,
        p.sale_price      AS salePrice,
        p.deadline_time   AS deadlineTime,
        p.notice          AS notice,
        p.image_url       AS imageUrl,
        p.store_lat       AS storeLat,
        p.store_lng       AS storeLng,
        p.created_at      AS createdAt,
        p.sale_quantity   AS saleQuantity,
        p.status          AS status,
        s.store_name      AS storeName,
        s.address         AS address
        FROM product_tb p
        JOIN seller_tb s ON p.seller_uid = s.uid
        WHERE p.seller_uid = #{sellerUid}
        AND p.status != 'DELETED'
        ORDER BY p.created_at DESC
    </select>

    <!-- =========================================================
     ✅ 9) 상품 상태 변경 (관리용)
     - ACTIVE / HIDDEN 등으로 변경
     - ProductService.changeStatus() 가 이 id를 쓰도록 맞추면 됨
    ========================================================= -->
    <update id="updateProductStatusForManage">
        UPDATE product_tb
        SET status = #{status}
        WHERE product_id = #{productId}
    </update>

    <!-- =========================================================
     ✅ 10) 소프트 삭제 (관리용)
     - status를 DELETED로 변경
    ========================================================= -->
    <update id="softDeleteProductForManage">
        UPDATE product_tb
        SET status = 'DELETED'
        WHERE product_id = #{productId}
    </update>

    <!-- =========================================================
     ✅ 11) (기존 서비스 호환용) 상태 변경
     - updateProductStatus 라는 id를 기존 서비스가 호출할 수도 있어서 남김
     - updateProductStatusForManage 와 SQL 동일
    ========================================================= -->
    <update id="updateProductStatus">
        UPDATE product_tb
        SET status = #{status}
        WHERE product_id = #{productId}
    </update>

    <!-- =========================================================
     ✅ 12) (기존 서비스 호환용) 소프트 삭제
     - ProductService.softDelete() 가 softDeleteProduct 를 호출하면 이게 필요
     ⚠️ parameterType="int"인데 SQL에서 #{productId}를 쓰려면
        인터페이스 메서드가 @Param("productId") 를 갖고 있어야 안전함
    ========================================================= -->
    <update id="softDeleteProduct" parameterType="int">
        UPDATE product_tb
        SET status = 'DELETED'
        WHERE product_id = #{productId}
    </update>



    <!-- ✅ 마감 지난 상품 자동 소프트삭제 -->
    <update id="softDeleteExpiredProducts">
        <![CDATA[
        UPDATE product_tb
        SET status = 'EXPIRED'
        WHERE (status IS NULL OR status = 'ACTIVE')
        AND deadline_time IS NOT NULL
        AND deadline_time <= NOW()
        ]]>
    </update>



</mapper>